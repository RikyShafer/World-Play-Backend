# ğŸ”§ Docker & PostgreSQL Troubleshooting Guide

##  Table of Contents
- [Quick Health Check](#-quick-health-check)
- [Common Issues & Fixes](#-common-issues--fixes)
- [Docker Cleanup & Restart](#-docker-cleanup--restart)
- [Database Management](#-database-management)
- [Development Commands](#-development-commands)

---

##  Quick Health Check

```bash
# 1. ×‘×“×•×§ ×©×›×œ ×”×§×•× ×˜×™×™× ×¨×™× ×¨×¦×™× (×¦×¨×™×š ×œ×¨××•×ª 3: db, app-server, media-server)
docker ps

# 2. ×‘×“×•×§ ×©×”-DB ××’×™×‘ (×××•×¨ ×œ×”×—×–×™×¨ ××ª ×’×¨×¡×ª PostgreSQL)
docker exec -it world-play-monorepo-db-1 psql -U user -d worldplaydb -c "SELECT version();"

# 3. ×‘×“×•×§ ×©×”×˜×‘×œ××•×ª ×§×™×™××•×ª (×××•×¨ ×œ×”×¨××•×ª ×¨×©×™××ª ×˜×‘×œ××•×ª)
docker exec -it world-play-monorepo-db-1 psql -U user -d worldplaydb -c "\dt"

# 4. ×‘×“×•×§ ×œ×•×’×™× ×× ×™×© ×©×’×™××•×ª
docker compose logs app-server --tail 50
docker compose logs media-server --tail 50
docker compose logs db --tail 50
```

---

##  Common Issues & Fixes

### ×‘×¢×™×” 1: ×¤×•×¨×˜ 5432 ×ª×¤×•×¡ (Port Conflict)

**×ª×¡××™× ×™×:** ×”×©×’×™××” `bind: address already in use` ××• Docker ×œ× ×¢×•×œ×”

```powershell
# Windows: ×‘×“×•×§ ××™ ×ª×•×¤×¡ ××ª ×”×¤×•×¨×˜
netstat -ano | findstr :5432

# ×× ×™×© ×ª×”×œ×™×š ×ª×§×•×¢ - ×¡×’×•×¨ ××•×ª×• (×›×× ×”×œ ××¢×¨×›×ª)
taskkill /PID <PID_NUMBER> /F

# ×× PostgreSQL ××•×ª×§×Ÿ ××§×•××™×ª - ×¢×¦×•×¨ ××ª ×”×©×™×¨×•×ª
Stop-Service postgresql*
```

```bash
# Linux/Mac: ×‘×“×•×§ ××™ ×ª×•×¤×¡ ××ª ×”×¤×•×¨×˜
lsof -i :5432

# ×¡×’×•×¨ ××ª ×”×ª×”×œ×™×š
kill -9 <PID>
```

**×¤×ª×¨×•×Ÿ:** ×× ×™×© PostgreSQL ××§×•××™ ×¨×¥, ×™×© 2 ××¤×©×¨×•×™×•×ª:
1. ×¢×¦×•×¨ ××•×ª×• ×œ×¤× ×™ ×”×¨×¦×ª Docker
2. ×©× ×” ××ª ×”×¤×•×¨×˜ ×‘-`docker-compose.yml` ×œ-`"5433:5432"`

---

### ×‘×¢×™×” 2: "Prisma Client Error" ×‘-Prisma Studio

**×ª×¡××™× ×™×:** Prisma Studio ×œ× ××¦×œ×™×— ×œ×”×ª×—×‘×¨

**×¡×™×‘×”:** ×”-`.env` ××¦×‘×™×¢ ×¢×œ `localhost` ××‘×œ ×”-DB ×¨×¥ ×¨×§ ×‘×ª×•×š Docker

**×¤×ª×¨×•×Ÿ:**
```bash
# ××•×¤×¦×™×” ×': ×”×¨×¥ Prisma Studio ×“×¨×š Docker
docker exec -it world-play-monorepo-app-server-1 npx prisma studio --port 5556

# ××•×¤×¦×™×” ×‘': ×—×©×•×£ ××ª ×”×¤×•×¨×˜ ×•×”×©×ª××© ×‘-.env ×¢× localhost
# (×•×•×“× ×©×™×© `ports: - "5432:5432"` ×‘-docker-compose.yml)
```

---

### ×‘×¢×™×” 3: ×©×™× ×•×™×™× ×‘-Schema ×œ× ××ª×¢×“×›× ×™×

**×ª×¡××™× ×™×:** ×¢×©×™×ª ×©×™× ×•×™×™× ×‘-`schema.prisma` ××‘×œ ×œ× ×¨×•××” ××•×ª×

```bash
# 1. ×¦×•×¨ migration ×—×“×©
docker exec -it world-play-monorepo-app-server-1 npx prisma migrate dev --name describe_your_change

# 2. ×× ×¦×¨×™×š ×œ××¤×¡ ××ª ×”-DB ×œ×’××¨×™ (âš ï¸ ××•×—×§ ××ª ×›×œ ×”××™×“×¢!)
docker compose down
docker volume rm world-play-monorepo_postgres_data
docker compose up -d
docker exec -it world-play-monorepo-app-server-1 npx prisma migrate deploy
```

---

##  Docker Cleanup & Restart

### × ×™×§×•×™ ×¨×’×™×œ (×©×•××¨ × ×ª×•× ×™×)
```bash
# ×¢×¦×•×¨ ××ª ×›×œ ×”×§×•× ×˜×™×™× ×¨×™×
docker compose down

# ×”×¨× ××—×“×©
docker compose up -d

# ×¦×¤×” ×‘×œ×•×’×™× ×‘×–××Ÿ ×××ª
docker compose logs -f
```

---

### × ×™×§×•×™ ××œ× (âš ï¸ ××•×—×§ ××ª ×›×œ ×”××™×“×¢!)

```bash
# 1. ×¢×¦×•×¨ ×”×›×œ
docker compose down

# 2. ××—×§ ××ª ×”-volume ×©×œ ×”-DB (×›×œ ×”× ×ª×•× ×™× ×™××—×§×•!)
docker volume rm world-play-monorepo_postgres_data

# 3. (××•×¤×¦×™×•× ×œ×™) × ×§×” ××ª ×›×œ ×”-cache ×©×œ Docker
docker system prune -a --volumes

# 4. ×”×¨× ××—×“×© + build
docker compose up --build -d

# 5. ×•×•×“× ×©×”×›×œ ×¨×¥
docker compose ps
```

---

### ×‘× ×™×” ××—×“×© ×©×œ ×§×•× ×˜×™×™× ×¨ ×¡×¤×¦×™×¤×™

```bash
# ×× ×©×™× ×™×ª ××©×”×• ×¨×§ ×‘-app-server
docker compose up --build app-server -d

# ×× ×©×™× ×™×ª ××©×”×• ×¨×§ ×‘-media-server
docker compose up --build media-server -d
```

---

##  Database Management

### ×’×™×©×” ×™×©×™×¨×” ×œ-PostgreSQL

```bash
# ×”×ª×—×‘×¨ ×œ-DB ×‘××•×¤×Ÿ ××™× ×˜×¨××§×˜×™×‘×™
docker exec -it world-play-monorepo-db-1 psql -U user -d worldplaydb

# ×¤×§×•×“×•×ª ×©×™××•×©×™×•×ª ×‘×ª×•×š psql:
# \dt           - ×¨×©×™××ª ×˜×‘×œ××•×ª
# \d users      - ××‘× ×” ×”×˜×‘×œ×” users
# \q            - ×™×¦×™××”
```

---

### Prisma Migrations

```bash
# ×”×¨×¥ migrations ×©×˜×¨× ×‘×•×¦×¢×•
docker exec -it world-play-monorepo-app-server-1 npx prisma migrate deploy

# ×¦×•×¨ migration ×—×“×© (×¤×™×ª×•×—)
docker exec -it world-play-monorepo-app-server-1 npx prisma migrate dev --name your_migration_name

# ××¤×¡ ××ª ×”-DB ×œ×’××¨×™ (âš ï¸ ××—×™×§×ª ×›×œ ×”××™×“×¢!)
docker exec -it world-play-monorepo-app-server-1 npx prisma migrate reset

# ×˜×¢×Ÿ × ×ª×•× ×™ seed (×× ×™×© ×§×•×‘×¥ seed)
docker exec -it world-play-monorepo-app-server-1 npx prisma db seed
# ×¤×•×ª×— ××ª ×¤×¨×™×–××” ×œ×¦×¤×™×™×” ×‘×“×¤×“×¤×Ÿ
docker exec -it world-play-backend-app-server-1 npx prisma studio
```

---

### Backup & Restore

```bash
# ×’×™×‘×•×™ ×©×œ ×”-DB
docker exec world-play-monorepo-db-1 pg_dump -U user worldplaydb > backup_$(date +%Y%m%d).sql

# ×©×—×–×•×¨ ××’×™×‘×•×™
docker exec -i world-play-monorepo-db-1 psql -U user -d worldplaydb < backup_20260110.sql
```

---

## ğŸ› ï¸ Development Commands

### App Server

```bash
# ×”×¨×¥ Prisma Studio (×××©×§ ×œ× ×™×”×•×œ DB)
docker exec -it world-play-monorepo-app-server-1 npx prisma studio

# ×¦×¤×” ×‘×œ×•×’×™× ×‘×–××Ÿ ×××ª
docker compose logs app-server -f

# ××ª×—×œ ××ª ×”×©×¨×ª ××—×“×©
docker compose restart app-server
```

---

### Media Server

```bash
# ×¦×¤×” ×‘×œ×•×’×™×
docker compose logs media-server -f

# ××ª×—×œ ××—×“×©
docker compose restart media-server
```

---

## ğŸ†˜ Emergency Reset (×›×©×”×›×œ ×§×¨×¡)

```bash
# 1. ×¢×¦×•×¨ ×”×›×œ
docker compose down

# 2. ××—×§ ××ª ×›×œ ×”-volumes
docker volume prune -f

# 3. ××—×§ ××ª ×›×œ ×”×ª××•× ×•×ª ×”×™×©× ×•×ª
docker image prune -a -f

# 4. ××—×§ ××ª ×”-volume ×”×¡×¤×¦×™×¤×™
docker volume rm world-play-monorepo_postgres_data

# 5. ×”×¨× ××—×“×©
docker compose up --build

# 6. ×‘×“×•×§ ×©×”×›×œ ×¨×¥
docker compose ps
```

---

## ğŸ“ Useful Notes

- **×¤×™×ª×•×— ××§×•××™:** ×× ×¨×•×¦×” ×œ×”×¨×™×¥ ××ª ×”×§×•×“ ××—×•×¥ ×œ-Docker, ×¦×¨×™×š PostgreSQL ××§×•××™ ×•×¢×“×›×Ÿ ××ª `DATABASE_URL` ×‘-`.env`
- **Production:** ×œ×¢×•×œ× ××œ ×ª×©×ª××© ×‘-`docker volume rm` ×‘×¡×‘×™×‘×ª ×™×™×¦×•×¨!
- **Logs:** ×”×©×ª××© ×‘-`--tail 100` ×›×“×™ ×œ×¨××•×ª ×¨×§ ××ª ×”×©×•×¨×•×ª ×”××—×¨×•× ×•×ª
- **×¤×•×¨×˜×™×:**
  - `8080` - App Server
  - `8000` - Media Server
  - `5432` - PostgreSQL
  - `5556` - Prisma Studio (××•×¤×¦×™×•× ×œ×™)
  - `10000-10100` - WebRTC (Media Server)

---

## ğŸ”— Quick Reference

```bash
# Status check
docker ps
docker compose ps

# Logs
docker compose logs -f
docker compose logs <service-name> --tail 50

# Restart specific service
docker compose restart <service-name>

# Enter container shell
docker exec -it world-play-monorepo-app-server-1 sh
docker exec -it world-play-monorepo-db-1 bash

# Clean up
docker compose down
docker volume prune
docker system prune -a
```
