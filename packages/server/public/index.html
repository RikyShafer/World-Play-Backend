<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Stream Test Lab</title>
    <style>
        body { font-family: sans-serif; background: #222; color: white; display: flex; flex-direction: column; align-items: center; }
        video { width: 400px; height: 300px; background: black; border: 2px solid red; margin: 20px; transform: scaleX(-1); }
        button { padding: 10px 20px; font-size: 18px; cursor: pointer; background: #e74c3c; color: white; border: none; border-radius: 5px; }
        #logs { width: 80%; height: 150px; background: #111; border: 1px solid #444; overflow-y: scroll; padding: 10px; font-family: monospace; }
        .status { color: #274de3; }
    </style>
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="mediasoup-client.min.js"></script>
</head>
<body>

    <h1>Server Test Lab</h1>
    <h3 id="connectionStatus" class="status">Disconnected</h3>
    
    <video id="localVideo" autoplay playsinline muted></video>
    <button onclick="startBroadcast()" id="btnStream">Start Broadcasting</button>
    
    <h3>Server Logs:</h3>
    <div id="logs"></div>

    <script>
        // --- הגדרות בדיקה ---
        const TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjU2YzY4NDdhLWY5OTUtNDdlOS04NGY3LWU2ZjA5YTAzMjU3OSIsInJvbGUiOiJWSUVXRVIiLCJlbWFpbCI6IkhPU1RORVdAdGVzdC5jb20iLCJpYXQiOjE3NjYzMTc0ODIsImV4cCI6MTc2NjMxOTI4Mn0.MLPjEXdUDeu7AdfrNF1DwkzJzm-PsKDcwHmhzTIvSd8";
        const STREAM_ID = "c3a5047a-4088-41fd-b249-3748d9cf4193"; 

        const socket = io({
          auth: {
            token: TOKEN 
          }
        });

        // פונקציית עזר ללוגים
        const log = (msg, isError = false) => {
            const div = document.getElementById('logs');
            div.innerHTML += `<span style="color: ${isError ? 'red' : '#0f0'}">> ${msg}</span><br>`;
            div.scrollTop = div.scrollHeight;
            console.log(msg);
        };

        // --- הפונקציה שהייתה חסרה! ---
        const sendRequest = (type, data) => {
            return new Promise((resolve, reject) => {
                socket.emit(type, data, (response) => {
                    if (response && response.error) {
                        reject(new Error(response.error));
                    } else {
                        resolve(response);
                    }
                });
            });
        };

        socket.on('connect', () => {
            document.getElementById('connectionStatus').innerText = "Connected to Socket ✅";
            document.getElementById('connectionStatus').style.color = "#2ecc71";
            log('Connected to server!');
        });

        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').innerText = "Disconnected ❌";
            document.getElementById('connectionStatus').style.color = "red";
            log('Disconnected from server.', true);
        });

        socket.on('connect_error', (err) => {
             log('Connection Error: ' + err.message, true);
        });

        async function startBroadcast() {
          try {
            log('Starting broadcast sequence...');

            // 1. create_room
            const roomParams = await sendRequest('stream:create_room', { 
                streamId: STREAM_ID 
            });
            log('Room Created successfully');
            console.log('Room Params:', roomParams);

            const device = new MediasoupClient.Device();
            await device.load({ routerRtpCapabilities: roomParams.rtpCapabilities });

            // 2. create_transport
            const transportParams = await sendRequest('stream:create_transport', { 
                streamId: STREAM_ID 
            });
            log('Transport Created on server');
            
            const producerTransport = device.createSendTransport(transportParams);

            producerTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
              try {
                await sendRequest('stream:connect_transport', {
                  transportId: producerTransport.id,
                  dtlsParameters,
                });
                callback();
              } catch (error) {
                errback(error);
              }
            });

            producerTransport.on('produce', async ({ kind, rtpParameters }, callback, errback) => {
              try {
                // --- השינוי החשוב: שליחת streamId ---
                const { id } = await sendRequest('stream:produce', {
                  transportId: producerTransport.id,
                  kind,
                  rtpParameters,
                  streamId: STREAM_ID // חובה לעדכון DB
                });
                callback({ id });
              } catch (error) {
                errback(error);
              }
            });

            // הפעלת מצלמה
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = stream;

            const track = stream.getVideoTracks()[0];
            await producerTransport.produce({ track });
            
            log('✅ Broadcasting started! Go check Prisma Studio (Stream status should be LIVE).');

          } catch (err) {
            console.error(err);
            log('❌ Error: ' + err.message, true);
          }
        }
    </script>
</body>
</html>