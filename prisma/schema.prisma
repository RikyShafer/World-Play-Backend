// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum UserRole {
  HOST
  PLAYER
  MODERATOR
  VIEWER
}

enum StreamStatus {
  WAITING
  PAUSE
  LIVE
  FINISHED
}

enum PointType {
  TRIVIA
  GAME
  DONATION
  BONUS
  PURCHASE 
}

enum TransactionType {
  PURCHASE
  EARN
  SPEND
  TRANSFER
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum MessageType {
  TEXT
  SYSTEM
  REACTION
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum NotificationType {
  SYSTEM
  GAME_INVITE
  REWARD
}

// --- TABLES ---

// 1. User Table
model User {
  id         String    @id @default(uuid())
  username   String
  email      String    @unique
  password   String?   // Optional (for Social Login)
  role       UserRole  @default(VIEWER)
  
  // Management & Status
  isActive       Boolean   @default(true)
  isVerified     Boolean   @default(false)
  lastActiveAt   DateTime? @map("last_active_at")
  
  // Auth & Identity
  phoneNumber    String?   @unique
  firebaseId     String?   // For Push Notifications
  googleId       String?   @unique
  facebookId     String?   @unique

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  followedBy     User[]    @relation("UserFollows")
  following      User[]    @relation("UserFollows")
  
  creditCards    CreditCard[] 
  hostedStreams  Stream[]  @relation("HostStreams")
  hostedGames    Game[]    @relation("HostGames")
  moderatedGames Game[]    @relation("ModeratorGames")
  participations GameParticipant[]
  points         UserPoint[]
  transactions   Transaction[]
  notifications  Notification[]
  viewLogs       ViewLog[]
  
  sentMessages     ChatMessage[] @relation("Sender")
  receivedMessages ChatMessage[] @relation("Receiver")

  @@map("users")
}

// 2. CreditCard Table
model CreditCard {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  last4Digits String   @map("last_4_digits") // MaxLength(4)
  token       String   // Payment provider token
  cvv         String?  // PCI compliance dependent
  expDate     String   @map("exp_date") // MM/YY
  tz          String?  // ID Number
  isDeleted   Boolean  @default(false) @map("is_deleted")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("credit_cards")
}

// 3. Stream Table
model Stream {
  id        String       @id @default(uuid())
  title     String
  hostId    String       @map("host_id")
  startTime DateTime?    @map("start_time")
  endTime   DateTime?    @map("end_time")
  status    StreamStatus @default(WAITING)

  host      User         @relation("HostStreams", fields: [hostId], references: [id])
  games     Game[]
  
  @@map("streams")
}

// 4. Game Table
model Game {
  id          String   @id @default(uuid())
  title       String
  description String?  @db.Text
  
  hostId      String   @map("host_id")
  moderatorId String?  @map("moderator_id")
  streamId    String   @map("stream_id")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  finishedAt  DateTime? @map("finished_at")

  host      User    @relation("HostGames", fields: [hostId], references: [id])
  moderator User?   @relation("ModeratorGames", fields: [moderatorId], references: [id])
  stream    Stream  @relation(fields: [streamId], references: [id])

  participants GameParticipant[]
  questions    Question[]
  viewLogs     ViewLog[]
  userPoints   UserPoint[] 

  @@map("games")
}

// 5. Game Participant Table
model GameParticipant {
  id       String   @id @default(uuid())
  gameId   String   @map("game_id")
  userId   String   @map("user_id")
  role     UserRole
  score    Int      @default(0)
  joinedAt DateTime @default(now()) @map("joined_at")

  game Game @relation(fields: [gameId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([gameId, userId])
  @@map("game_participants")
}

// 6. Question Table
model Question {
  id           String   @id @default(uuid())
  gameId       String   @map("game_id") 
  questionText String   @map("question_text")
  options      Json     @map("options") 
  createdAt    DateTime @default(now()) @map("created_at")

  game Game @relation(fields: [gameId], references: [id])
  
  @@map("questions")
}

// 7. User Points Table
model UserPoint {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  pointType     PointType @map("point_type")
  amount        Int
  receivedAt    DateTime  @default(now()) @map("received_at")

  // Optional relations
  transactionId String?   @map("transaction_id")
  gameId        String?   @map("game_id")

  user        User         @relation(fields: [userId], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])
  game        Game?        @relation(fields: [gameId], references: [id])

  @@map("user_points")
}

// 8. Transaction Table
model Transaction {
  id            String            @id @default(uuid())
  userId        String            @map("user_id")
  type          TransactionType
  status        TransactionStatus @default(PENDING)
  amount        Int
  description   String?
  failureReason String?           @map("failure_reason")
  paymentMethod String?           @map("payment_method")
  last4Digits   String?           @map("last_4_digits")
  createdAt     DateTime          @default(now()) @map("created_at")

  user       User        @relation(fields: [userId], references: [id])
  userPoints UserPoint[]

  @@map("transactions")
}

// 9. Chat Message Table
model ChatMessage {
  id          String        @id @default(uuid())
  senderId    String        @map("sender_id")
  receiverId  String        @map("receiver_id")
  messageText String        @map("message_text")
  messageType MessageType   @map("message_type")
  status      MessageStatus @default(SENT)
  createdAt   DateTime      @default(now()) @map("created_at")

  sender   User @relation("Sender", fields: [senderId], references: [id])
  receiver User @relation("Receiver", fields: [receiverId], references: [id])

  @@map("chat_messages")
}

// 10. Notification Table
model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  content   String
  isRead    Boolean          @default(false) @map("is_read")
  sendDate  DateTime         @default(now()) @map("send_date")
  readDate  DateTime?        @map("read_date")

  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}

// 11. ViewLog Table (Analytics)
model ViewLog {
  id                   String   @id @default(uuid())
  userId               String   @map("user_id")
  gameId               String   @map("game_id")
  duration             Int      
  answersCount         Int      @map("answers_count")
  participationPercent Float    @map("participation_percent")
  createdAt            DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])
  game Game @relation(fields: [gameId], references: [id])

  @@index([userId, createdAt])
  @@map("view_logs")
}